<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wegreen | Pagamento</title>

    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="src/js/wegreen-modals.js"></script>

    <link rel="stylesheet" href="src/css/checkout.css">
  </head>

  <body>
    <div class="container py-5">
      <h2 class="fw-bold mb-4 text-center">Finalizar Compra</h2>

      <div class="row g-4">
        
        <div class="col-lg-5">
          <div class="checkout-card p-4">
            <h5 class="fw-bold mb-3">Resumo da Encomenda</h5>
            <div id="orderItems" class="order-summary mb-3"></div>
            <hr />
            <div class="d-flex justify-content-between">
              <span>Subtotal</span>
              <strong>€<span id="subtotal">0.00</span></strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Descontos</span>
              <strong class="text-success"
                >- €<span id="descontos">0.00</span></strong
              >
            </div>
            <hr />
            <div class="d-flex justify-content-between fs-5">
              <strong>Total</strong>
              <strong>€<span id="total">0.00</span></strong>
            </div>
          </div>
        </div>

        
        <div class="col-lg-7">
          <div class="checkout-card p-4">
            <h5 class="fw-bold mb-3">Informações de Pagamento</h5>

            
            <div class="payment-methods mb-4">
              <label class="d-block payment-option mb-2">
                <input type="radio" name="pagamento" value="mbway" />
                <img src="src/img/Logo_MBWay.svg.png" alt="MB Way" /> MB Way
              </label>
              <label class="d-block payment-option mb-2">
                <input type="radio" name="pagamento" value="multibanco" />
                <img src="src/img/icons8-multibanco-48.png" alt="Multibanco" />
                Multibanco
              </label>
              <label class="d-block payment-option mb-2">
                <input type="radio" name="pagamento" value="paypal" />
                <img src="src/img/Paypal_2014_logo.png" alt="PayPal" /> PayPal
              </label>
              <label class="d-block payment-option">
                <input type="radio" name="pagamento" value="googlepay" />
                <img src="src/img/Google_Pay_Logo.svg.webp" alt="Google Pay" />
                Google Pay
              </label>
            </div>

            
            <div id="formPagamento" class="mb-4"></div>

            
            <h5 class="fw-bold mb-3">Método de Entrega</h5>
            <select id="entrega" class="form-select mb-4">
              <option value="casa">Entrega em Casa</option>
              <option value="loja">Levantamento em Loja Física</option>
              <option value="CTT">CTT Express</option>
              <option value="DPD">DPD</option>
            </select>

            
            <input
              type="text"
              id="nomeCompleto"
              class="form-control mb-3"
              placeholder="Nome Completo"
              required
            />
            <input
              type="email"
              id="emailCliente"
              class="form-control mb-3"
              placeholder="E-mail"
              required
            />
            <input
              type="text"
              id="moradaEntrega"
              class="form-control mb-3"
              placeholder="Morada de Entrega"
              required
            />
            <input
              type="text"
              id="codigoPostal"
              class="form-control mb-3"
              placeholder="Código Postal (0000-000)"
              required
            />

            
            <button
              id="btnFinalizar"
              class="btn btn-wegreen-accent w-100 rounded-pill text-white fw-bold"
            >
              <span class="loading spinner-border spinner-border-sm"></span>
              Finalizar Compra
            </button>
          </div>
        </div>
      </div>
    </div>

    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        
        const carrinho = JSON.parse(localStorage.getItem("carrinho") || "[]");
        let produtosValidados = [];
      let isAuthenticated = false;

      
      function verificarAutenticacao() {
        $.ajax({
          type: "POST",
          url: "src/controller/controllerCheckout.php",
          data: { op: 5 },
          dataType: "json",
          success: function(response) {
            isAuthenticated = response.autenticado;

            
            if (!isAuthenticated) {
              const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000,
                timerProgressBar: true
              });
              Toast.fire({
                icon: 'info',
                title: 'Sessão como visitante',
                text: 'Faça login para finalizar a compra'
              });
            }
          }
        });
      }

      
      function validarProdutos() {
        if (carrinho.length === 0) return;

        $.ajax({
          type: "POST",
          url: "controller/controllerCheckout.php",
          data: {
            op: 1,
            produtos: JSON.stringify(carrinho),
          },
          dataType: "json",
          success: function (response) {
            if (response.success) {
              produtosValidados = response.produtos_validos;

              if (response.produtos_invalidos.length > 0) {
                Swal.fire({
                  icon: "warning",
                  title: "Alguns produtos não estão disponíveis",
                  text:
                    "Os seguintes produtos foram removidos: " +
                    response.produtos_invalidos.join(", "),
                  confirmButtonColor: "#adff2f",
                });
              }

              mostrarResumo();
            }
          },
          error: function () {
            Swal.fire({
              icon: "error",
              title: "Erro",
              text: "Erro ao validar produtos",
            });
          },
        });
      }

      
        function mostrarResumo() {
          const orderItems = document.getElementById("orderItems");
          const subtotalEl = document.getElementById("subtotal");
          const totalEl = document.getElementById("total");
          const descontosEl = document.getElementById("descontos");

          orderItems.innerHTML = "";
          let subtotal = 0;

          produtosValidados.forEach((item) => {
            subtotal += Number(item.preco);
            const div = document.createElement("div");
            div.className =
              "d-flex align-items-center justify-content-between mb-3";
            div.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="${item.foto}" class="me-3">
              <div>
                <p class="fw-bold mb-1">${item.nome}</p>
              </div>
            </div>
            <span>€${item.preco.toFixed(2)}</span>
          `;
            orderItems.appendChild(div);
          });

          
          $.ajax({
            type: "POST",
            url: "controller/controllerCheckout.php",
            data: {
              op: 6,
              subtotal: subtotal,
            },
            dataType: "json",
            success: function (response) {
              if (response.success) {
                subtotalEl.textContent = subtotal.toFixed(2);
                descontosEl.textContent = response.desconto.toFixed(2);
                totalEl.textContent = response.total.toFixed(2);
              }
            },
          });
        }

        
        const formPagamento = document.getElementById("formPagamento");
        const radios = document.querySelectorAll('input[name="pagamento"]');

        radios.forEach((r) => {
          r.addEventListener("change", (e) => {
            const tipo = e.target.value;
            let html = "";

            if (tipo === "mbway") {
              html = `
              <label>Número MB Way:</label>
              <input type="tel" id="inputPagamento" class="form-control mb-3" placeholder="912345678" required>
            `;
            } else if (tipo === "multibanco") {
              html = `
              <label>Entidade:</label>
              <input type="text" id="entidadeMultibanco" class="form-control mb-2" placeholder="Entidade">
              <label>Referência:</label>
              <input type="text" id="referenciaMultibanco" class="form-control mb-3" placeholder="Referência">
            `;
            } else if (tipo === "paypal") {
              html = `
              <label>E-mail da Conta PayPal:</label>
              <input type="email" id="inputPagamento" class="form-control mb-3" placeholder="email@paypal.com">
            `;
            } else if (tipo === "googlepay") {
              html = `
              <label>ID da Conta Google Pay:</label>
              <input type="text" id="inputPagamento" class="form-control mb-3" placeholder="ID Google Pay">
            `;
            }
            formPagamento.innerHTML = html;
          });
        });

        
        document
          .getElementById("btnFinalizar")
          .addEventListener("click", function (e) {
            e.preventDefault();

            const btn = this;
            const loading = btn.querySelector(".loading");

            
            $.ajax({
              type: "POST",
              url: "src/controller/controllerCheckout.php",
              data: { op: 5 }, 
              dataType: "json",
              async: false, 
              success: function(authResponse) {
                if (!authResponse.autenticado) {
                  
                  autoGuardarDados();

                  Swal.fire({
                    icon: "info",
                    title: "Autenticação Necessária",
                    text: "Por favor, inicie sessão para finalizar a compra.",
                    confirmButtonColor: "#adff2f",
                    confirmButtonText: "Ir para Login"
                  }).then(() => {
                    
                    window.location.href = "login.html?redirect=checkout.html";
                  });
                  return;
                }
              }
            });

            
            if (produtosValidados.length === 0) {
              Swal.fire({
                icon: "error",
                title: "Carrinho vazio!",
                text: "Adiciona um produto antes de finalizar a compra.",
              });
              return;
            }

            const metodoPagamento = document.querySelector(
              'input[name="pagamento"]:checked',
            );
            if (!metodoPagamento) {
              Swal.fire({
                icon: "warning",
                title: "Método de pagamento",
                text: "Por favor selecione um método de pagamento",
              });
              return;
            }

            
            let dadosPagamento = {};
            if (metodoPagamento.value === "mbway") {
              dadosPagamento = {
                numero: document.getElementById("inputPagamento").value,
              };
            } else if (metodoPagamento.value === "multibanco") {
              dadosPagamento = {
                entidade: document.getElementById("entidadeMultibanco").value,
                referencia: document.getElementById("referenciaMultibanco").value,
              };
            } else if (metodoPagamento.value === "paypal") {
              dadosPagamento = {
                email: document.getElementById("inputPagamento").value,
              };
            } else if (metodoPagamento.value === "googlepay") {
              dadosPagamento = {
                id_conta: document.getElementById("inputPagamento").value,
              };
            }

            
            btn.disabled = true;
            loading.classList.add("active");

            
            $.ajax({
              type: "POST",
              url: "controller/controllerCheckout.php",
              data: {
                op: 4,
                nome: document.getElementById("nomeCompleto").value,
                email: document.getElementById("emailCliente").value,
                morada: document.getElementById("moradaEntrega").value,
                codigo_postal: document.getElementById("codigoPostal").value,
                metodo_entrega: document.getElementById("entrega").value,
                metodo_pagamento: metodoPagamento.value,
                dados_pagamento: JSON.stringify(dadosPagamento),
                produtos: JSON.stringify(produtosValidados),
              },
              dataType: "json",
              success: function (response) {
                btn.disabled = false;
                loading.classList.remove("active");

                if (response.success) {
                  
                  $.ajax({
                    type: "POST",
                    url: "src/controller/controllerCheckout.php",
                    data: { op: 4 },
                    dataType: "json",
                  });

                  Swal.fire({
                    icon: "success",
                    title: "Compra Finalizada 🌿",
                    html: `
                  <p>Obrigado por escolher a Wegreen!</p>
                  <p>Códigos das encomendas:</p>
                  <ul>${response.encomendas.map((cod) => "<li>" + cod + "</li>").join("")}</ul>
                  <p>Irá receber a confirmação por e-mail.</p>
                `,
                    confirmButtonColor: "#adff2f",
                  }).then(() => {
                    localStorage.removeItem("carrinho");
                    window.location.href = "index.html";
                  });
                } else {
                  Swal.fire({
                    icon: "error",
                    title: "Erro ao processar compra",
                    text: response.msg,
                  });
                }
              },
              error: function () {
                btn.disabled = false;
                loading.classList.remove("active");

                Swal.fire({
                  icon: "error",
                  title: "Erro",
                  text: "Erro ao processar checkout. Tente novamente.",
                });
              },
            });
          });

        
        verificarAutenticacao();
        validarProdutos();
        carregarDadosCheckout();

        
        function carregarDadosCheckout() {
          $.ajax({
            type: "POST",
            url: "src/controller/controllerCheckout.php",
            data: { op: 3 },
            dataType: "json",
            success: function (response) {
              if (response.success && response.data) {
                const data = response.data;

                
                if (data.nome)
                  document.getElementById("nomeCompleto").value = data.nome;
                if (data.email)
                  document.getElementById("emailCliente").value = data.email;
                if (data.morada)
                  document.getElementById("moradaEntrega").value = data.morada;
                if (data.codigo_postal)
                  document.getElementById("codigoPostal").value =
                    data.codigo_postal;

                
                if (data.metodo_entrega)
                  document.getElementById("entrega").value = data.metodo_entrega;

                
                if (data.metodo_pagamento) {
                  const radioBtn = document.querySelector(
                    `input[name="pagamento"][value="${data.metodo_pagamento}"]`,
                  );
                  if (radioBtn) {
                    radioBtn.checked = true;
                    radioBtn.dispatchEvent(new Event("change")); 

                    
                    setTimeout(() => {
                      if (data.dados_pagamento) {
                        const dadosPag = JSON.parse(data.dados_pagamento);

                        if (
                          data.metodo_pagamento === "mbway" &&
                          dadosPag.numero
                        ) {
                          document.getElementById("inputPagamento").value =
                            dadosPag.numero;
                        } else if (data.metodo_pagamento === "multibanco") {
                          if (dadosPag.entidade)
                            document.getElementById("entidadeMultibanco").value =
                              dadosPag.entidade;
                          if (dadosPag.referencia)
                            document.getElementById(
                              "referenciaMultibanco",
                            ).value = dadosPag.referencia;
                        } else if (
                          data.metodo_pagamento === "paypal" &&
                          dadosPag.email
                        ) {
                          document.getElementById("inputPagamento").value =
                            dadosPag.email;
                        } else if (
                          data.metodo_pagamento === "googlepay" &&
                          dadosPag.id_conta
                        ) {
                          document.getElementById("inputPagamento").value =
                            dadosPag.id_conta;
                        }
                      }
                    }, 100);
                  }
                }
              }
            },
          });
        }

        
        function autoGuardarDados() {
          const metodoPagamento = document.querySelector(
            'input[name="pagamento"]:checked',
          );
          let dadosPagamento = {};

          if (metodoPagamento) {
            if (metodoPagamento.value === "mbway") {
              const input = document.getElementById("inputPagamento");
              if (input) dadosPagamento = { numero: input.value };
            } else if (metodoPagamento.value === "multibanco") {
              const entidade = document.getElementById("entidadeMultibanco");
              const referencia = document.getElementById("referenciaMultibanco");
              if (entidade && referencia) {
                dadosPagamento = {
                  entidade: entidade.value,
                  referencia: referencia.value,
                };
              }
            } else if (metodoPagamento.value === "paypal") {
              const input = document.getElementById("inputPagamento");
              if (input) dadosPagamento = { email: input.value };
            } else if (metodoPagamento.value === "googlepay") {
              const input = document.getElementById("inputPagamento");
              if (input) dadosPagamento = { id_conta: input.value };
            }
          }

          $.ajax({
            type: "POST",
            url: "src/controller/controllerCheckout.php",
            data: {
              op: 2,
              nome: document.getElementById("nomeCompleto").value,
              email: document.getElementById("emailCliente").value,
              morada: document.getElementById("moradaEntrega").value,
              codigo_postal: document.getElementById("codigoPostal").value,
              metodo_entrega: document.getElementById("entrega").value,
              metodo_pagamento: metodoPagamento ? metodoPagamento.value : null,
              dados_pagamento: JSON.stringify(dadosPagamento),
            },
            dataType: "json",
          });
        }

        
        const camposParaGuardar = [
          "nomeCompleto",
          "emailCliente",
          "moradaEntrega",
          "codigoPostal",
          "entrega",
        ];
        camposParaGuardar.forEach((id) => {
          const campo = document.getElementById(id);
          if (campo) {
            campo.addEventListener("blur", autoGuardarDados); 
          }
        });

        
        document.querySelectorAll('input[name="pagamento"]').forEach((radio) => {
          radio.addEventListener("change", () => {
            setTimeout(autoGuardarDados, 500); 
          });
        });

        
        document.addEventListener(
          "blur",
          function (e) {
            if (
              e.target.id === "inputPagamento" ||
              e.target.id === "entidadeMultibanco" ||
              e.target.id === "referenciaMultibanco"
            ) {
              autoGuardarDados();
            }
          },
          true,
        );
    </script>
  </body>
</html>

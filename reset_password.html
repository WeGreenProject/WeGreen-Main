<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Password - WeGreen</title>
    <link href="src/css/style.bundle.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="src/css/resetPassword.css">
</head>
<body>
    <div class="reset-card">
        
        <div class="logo">
            <h1>üå± WeGreen</h1>
            <p class="text-muted">Redefinir Password</p>
        </div>

        
        <div id="alertContainer"></div>

        
        <div id="loadingScreen">
            <div class="spinner-border text-success mb-3" role="status">
                <span class="visually-hidden">A validar...</span>
            </div>
            <p class="text-muted">A validar o seu pedido...</p>
        </div>

        
        <form id="resetForm">
            <input type="hidden" id="token" name="token">
            
            <div class="mb-3">
                <label class="form-label fw-bold">Email</label>
                <input type="email" 
                       class="form-control form-control-lg" 
                       id="userEmail" 
                       disabled>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">Nova Password</label>
                <input type="password" 
                       class="form-control form-control-lg" 
                       id="nova_password" 
                       placeholder="M√≠nimo 6 caracteres"
                       required
                       minlength="6">
                <div class="password-strength" id="passwordStrength"></div>
                <div class="form-text" id="strengthText"></div>
            </div>

            <div class="mb-4">
                <label class="form-label fw-bold">Confirmar Password</label>
                <input type="password" 
                       class="form-control form-control-lg" 
                       id="confirmar_password" 
                       placeholder="Digite novamente"
                       required
                       minlength="6">
            </div>

            <button type="submit" class="btn btn-success btn-lg w-100 mb-3" id="btnSubmit">
                <span class="indicator-label">üîì Redefinir Password</span>
                <span class="indicator-progress" style="display: none;">
                    Processando... <span class="spinner-border spinner-border-sm ms-2"></span>
                </span>
            </button>

            <div class="text-center">
                <a href="login.html" class="text-muted">
                    ‚Üê Voltar ao Login
                </a>
            </div>
        </form>
    </div>

    <script src="src/js/scripts.bundle.js"></script>
    <script>
        let tokenValidado = false;

        
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        
        window.addEventListener('DOMContentLoaded', async function() {
            if (!token) {
                showAlert('Token n√£o fornecido. Por favor, use o link do email.', 'danger');
                document.getElementById('loadingScreen').style.display = 'none';
                return;
            }

            document.getElementById('token').value = token;

            try {
                const formData = new FormData();
                formData.append('op', '2');
                formData.append('token', token);

                const response = await fetch('src/controller/controllerPasswordReset.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.flag) {
                    tokenValidado = true;
                    document.getElementById('userEmail').value = result.data.email;
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('resetForm').style.display = 'block';
                    showAlert('Token v√°lido! Pode definir a sua nova password.', 'success');
                } else {
                    document.getElementById('loadingScreen').innerHTML = `
                        <div class="text-center">
                            <div class="text-danger mb-3" style="font-size: 48px;">‚ùå</div>
                            <h5 class="text-danger">Token Inv√°lido ou Expirado</h5>
                            <p class="text-muted mb-3">${result.msg}</p>
                            <a href="recuperar_password.html" class="btn btn-primary">
                                Solicitar Novo Link
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loadingScreen').innerHTML = `
                    <div class="text-center">
                        <div class="text-danger mb-3" style="font-size: 48px;">‚ö†Ô∏è</div>
                        <h5 class="text-danger">Erro ao Validar Token</h5>
                        <p class="text-muted mb-3">Tente novamente mais tarde.</p>
                        <a href="recuperar_password.html" class="btn btn-primary">
                            Voltar
                        </a>
                    </div>
                `;
            }
        });

        
        document.getElementById('nova_password').addEventListener('input', function() {
            const password = this.value;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('strengthText');

            if (password.length === 0) {
                strengthBar.className = 'password-strength';
                strengthText.textContent = '';
                return;
            }

            let strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;

            if (strength <= 2) {
                strengthBar.className = 'password-strength weak';
                strengthText.textContent = 'Password fraca';
                strengthText.style.color = '#dc2626';
            } else if (strength <= 4) {
                strengthBar.className = 'password-strength medium';
                strengthText.textContent = 'Password m√©dia';
                strengthText.style.color = '#f59e0b';
            } else {
                strengthBar.className = 'password-strength strong';
                strengthText.textContent = 'Password forte';
                strengthText.style.color = '#22c55e';
            }
        });

        
        document.getElementById('resetForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!tokenValidado) {
                showAlert('Token inv√°lido. N√£o √© poss√≠vel redefinir a password.', 'danger');
                return;
            }

            const nova_password = document.getElementById('nova_password').value;
            const confirmar_password = document.getElementById('confirmar_password').value;
            const btnSubmit = document.getElementById('btnSubmit');

            
            if (nova_password.length < 6) {
                showAlert('A password deve ter pelo menos 6 caracteres.', 'warning');
                return;
            }

            if (nova_password !== confirmar_password) {
                showAlert('As passwords n√£o coincidem.', 'warning');
                return;
            }

            
            btnSubmit.querySelector('.indicator-label').style.display = 'none';
            btnSubmit.querySelector('.indicator-progress').style.display = 'inline-block';
            btnSubmit.disabled = true;

            try {
                const formData = new FormData();
                formData.append('op', '3');
                formData.append('token', token);
                formData.append('nova_password', nova_password);

                const response = await fetch('src/controller/controllerPasswordReset.php', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.flag) {
                    showAlert(result.msg, 'success');
                    document.getElementById('resetForm').reset();
                    
                    
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 3000);
                } else {
                    showAlert(result.msg, 'danger');
                }

            } catch (error) {
                console.error('Erro:', error);
                showAlert('Erro ao processar pedido. Tente novamente.', 'danger');
            } finally {
                
                btnSubmit.querySelector('.indicator-label').style.display = 'inline-block';
                btnSubmit.querySelector('.indicator-progress').style.display = 'none';
                btnSubmit.disabled = false;
            }
        });

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'warning' ? 'alert-warning' : 'alert-danger';
            const icon = type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ùå';

            alertContainer.innerHTML = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <strong>${icon}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            
            if (type !== 'success') {
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        }
    </script>
</body>
</html>

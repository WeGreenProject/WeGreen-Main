<!doctype html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Redefinir Password - WeGreen</title>
    <link rel="stylesheet" href="src/css/login.css" />
    <link rel="stylesheet" href="src/css/resetPassword.css" />
    <link rel="icon" type="image/png" href="src/img/WeGreenfav.png" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="src/js/wegreen-modals.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <div class="auth-container">
      <div class="auth-background">
        <div class="gradient-overlay"></div>
        <div class="floating-shapes">
          <div class="shape shape-1"></div>
          <div class="shape shape-2"></div>
          <div class="shape shape-3"></div>
        </div>
      </div>

      <div class="auth-card auth-card-reset">
        <div class="auth-header">
          <div class="logo">
            <img
              src="src/img/2-removebg-preview.png"
              alt="WeGreen"
              class="logo-img"
              style="width: auto; height: 40px"
            />
          </div>
          <h1>Redefinir Password</h1>
          <p>Defina uma nova palavra-passe para a sua conta</p>
        </div>

        <input type="hidden" id="token" name="token" />

        <div id="loadingScreen" class="loading-screen">
          <div class="mini-spinner"></div>
          <p>A validar o seu pedido...</p>
        </div>

        <div
          id="statusMessage"
          class="status-message"
          style="display: none"
        ></div>

        <form class="auth-form" id="resetForm" style="display: none">
          <div class="input-group email-group">
            <div class="input-icon">
              <i class="fas fa-envelope"></i>
            </div>
            <input type="email" id="userEmail" placeholder="Email" disabled />
            <label>Email</label>
          </div>

          <div class="input-group">
            <div class="input-icon">
              <i class="fas fa-lock"></i>
            </div>
            <input
              type="password"
              id="nova_password"
              placeholder="Mínimo 6 caracteres"
              required
              minlength="6"
            />
            <label>Nova Password</label>
            <button
              type="button"
              class="toggle-password"
              onclick="togglePassword('nova_password')"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="password-strength" id="passwordStrength"></div>
          <div class="strength-text" id="strengthText"></div>

          <div class="input-group">
            <div class="input-icon">
              <i class="fas fa-lock"></i>
            </div>
            <input
              type="password"
              id="confirmar_password"
              placeholder="Digite novamente"
              required
              minlength="6"
            />
            <label>Confirmar Password</label>
            <button
              type="button"
              class="toggle-password"
              onclick="togglePassword('confirmar_password')"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <button type="submit" class="btn-primary" id="btnSubmit">
            <span class="indicator-label">Redefinir Password</span>
            <span class="indicator-progress" style="display: none">
              Processando...
            </span>
          </button>
        </form>

        <div class="auth-footer">
          <p>
            <a href="login.html" class="link-primary">
              <i class="fas fa-arrow-left"></i> Voltar ao Login
            </a>
          </p>
          <p id="newLinkContainer" style="display: none; margin-top: 10px">
            <a href="recuperar_password.html" class="link-primary">
              Solicitar novo link de recuperação
            </a>
          </p>
        </div>
      </div>
    </div>

    <script>
      let tokenValidado = false;
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      function togglePassword(fieldId) {
        const field = document.getElementById(fieldId);
        const button = field.parentElement.querySelector(".toggle-password");
        const icon = button.querySelector("i");

        if (field.type === "password") {
          field.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          field.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      function setStatusMessage(message, type) {
        const statusElement = document.getElementById("statusMessage");
        statusElement.textContent = message;
        statusElement.className = "status-message " + (type || "info");
        statusElement.style.display = "block";
      }

      window.addEventListener("DOMContentLoaded", async function () {
        if (!token) {
          document.getElementById("loadingScreen").style.display = "none";
          setStatusMessage(
            "Token não fornecido. Utilize o link recebido por email.",
            "error",
          );
          document.getElementById("newLinkContainer").style.display = "block";
          return;
        }

        document.getElementById("token").value = token;

        try {
          const formData = new FormData();
          formData.append("op", "2");
          formData.append("token", token);

          const response = await fetch(
            "src/controller/controllerPasswordReset.php",
            {
              method: "POST",
              body: formData,
            },
          );

          const result = await response.json();

          if (result.flag) {
            tokenValidado = true;
            document.getElementById("userEmail").value = result.data.email;
            document.getElementById("loadingScreen").style.display = "none";
            document.getElementById("resetForm").style.display = "flex";
            setStatusMessage(
              "Token válido! Pode definir a sua nova password.",
              "success",
            );
          } else {
            document.getElementById("loadingScreen").style.display = "none";
            setStatusMessage(
              result.msg || "Token inválido ou expirado.",
              "error",
            );
            document.getElementById("newLinkContainer").style.display = "block";
          }
        } catch (error) {
          console.error("Erro:", error);
          document.getElementById("loadingScreen").style.display = "none";
          setStatusMessage(
            "Erro ao validar token. Tente novamente mais tarde.",
            "error",
          );
          document.getElementById("newLinkContainer").style.display = "block";
        }
      });

      document
        .getElementById("nova_password")
        .addEventListener("input", function () {
          const password = this.value;
          const strengthBar = document.getElementById("passwordStrength");
          const strengthText = document.getElementById("strengthText");

          if (password.length === 0) {
            strengthBar.className = "password-strength";
            strengthText.textContent = "";
            return;
          }

          let strength = 0;
          if (password.length >= 6) strength++;
          if (password.length >= 8) strength++;
          if (/[A-Z]/.test(password)) strength++;
          if (/[0-9]/.test(password)) strength++;
          if (/[^A-Za-z0-9]/.test(password)) strength++;

          if (strength <= 2) {
            strengthBar.className = "password-strength weak";
            strengthText.textContent = "Password fraca";
          } else if (strength <= 4) {
            strengthBar.className = "password-strength medium";
            strengthText.textContent = "Password média";
          } else {
            strengthBar.className = "password-strength strong";
            strengthText.textContent = "Password forte";
          }
        });

      document
        .getElementById("resetForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          if (!tokenValidado) {
            showModernErrorModal(
              "Erro",
              "Token inválido. Não é possível redefinir a password.",
            );
            return;
          }

          const novaPassword = document.getElementById("nova_password").value;
          const confirmarPassword =
            document.getElementById("confirmar_password").value;
          const btnSubmit = document.getElementById("btnSubmit");

          if (novaPassword.length < 6) {
            showModernWarningModal(
              "Atenção",
              "A password deve ter pelo menos 6 caracteres.",
            );
            return;
          }

          if (novaPassword !== confirmarPassword) {
            showModernWarningModal("Atenção", "As passwords não coincidem.");
            return;
          }

          btnSubmit.querySelector(".indicator-label").style.display = "none";
          btnSubmit.querySelector(".indicator-progress").style.display =
            "inline-block";
          btnSubmit.disabled = true;

          try {
            const formData = new FormData();
            formData.append("op", "3");
            formData.append("token", token);
            formData.append("nova_password", novaPassword);

            const response = await fetch(
              "src/controller/controllerPasswordReset.php",
              {
                method: "POST",
                body: formData,
              },
            );

            const result = await response.json();

            if (result.flag) {
              showModernSuccessModal(
                "Password atualizada",
                result.msg || "A sua password foi redefinida com sucesso.",
              ).then(() => {
                window.location.href = "login.html";
              });
            } else {
              showModernErrorModal(
                "Erro",
                result.msg || "Não foi possível redefinir a password.",
              );
            }
          } catch (error) {
            console.error("Erro:", error);
            showModernErrorModal(
              "Erro",
              "Erro ao processar pedido. Tente novamente.",
            );
          } finally {
            btnSubmit.querySelector(".indicator-label").style.display =
              "inline-block";
            btnSubmit.querySelector(".indicator-progress").style.display =
              "none";
            btnSubmit.disabled = false;
          }
        });
    </script>
  </body>
</html>
